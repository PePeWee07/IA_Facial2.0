# Proyecto de Servidor de DetecciÃ³n de Rostros 

Hemos creado una aplicaciÃ³n utilizando Python con el framework Flask, que tiene la capacidad de detectar rostros en imÃ¡genes, recortarlos y cifrarlos para garantizar la seguridad de los datos sensibles.

## ğŸ“œCaracterÃ­sticas destacadas

- **DetecciÃ³n de Rostro** 

- **Recorte y CodificaciÃ³n** 

- **Almacenamiento de CodificaciÃ³n** 

## ğŸ“Instrucciones de Uso

1. **Clonar el Repositorio:** Comienza por clonar este repositorio en tu mÃ¡quina local utilizando el comando:

   ```
   git clone https://github.com/PePeWee07/IA-Facial2.0
   ```

2. **Instalar Dependencias:** Accede al directorio del proyecto e instala las dependencias necesarias `pip install`.

    - torch
    - cmake
    - dlib
    - facenet_pytorch
    - matplotlib
    - face_recognition


3. **En caso de Error con `dlib` seguir los pasos**
    ```
    https://github.com/z-mahmud22/Dlib_Windows_Python3.x
    ```

## ğŸ“š ExplicaciÃ³n del Redimensionamiento

### ğŸ‘‰ CondiciÃ³n de Redimensionamiento en el CÃ³digo
```python
if max(orig_width, orig_height) > max_dim and min(orig_width, orig_height) > 400:
```
Esta condiciÃ³n significa que la imagen **solo se redimensionarÃ¡ si:**
1. **El lado mÃ¡s grande supera 800px** (`max_dim = 800`).
2. **El lado mÃ¡s pequeÃ±o supera 400px** (`min(orig_width, orig_height) > 400`).

Esto permite optimizar el procesamiento de imÃ¡genes sin afectar la calidad de aquellas que ya tienen un tamaÃ±o adecuado.

### ğŸ“ Ejemplo de Funcionamiento en Diferentes Casos
| **TamaÃ±o Original** | **Se Redimensiona?** | **RazÃ³n** |
|------------------|---------------|--------|
| **1000x650**    | âœ… SÃ­         | El ancho (`1000px`) es mayor a `800px`, y la altura (`650px`) es mayor a `400px`. |
| **800x500**      | âœ… SÃ­         | El ancho (`800px`) cumple con el umbral mÃ¡ximo, y la altura (`500px`) es mayor a `400px`. |
| **800x300**      | âŒ No         | Aunque `800px` cumple el umbral mÃ¡ximo, `300px` es menor a `400px`, por lo que no se toca. |
| **600x400**      | âŒ No         | Ninguno de los lados supera `800px`, asÃ­ que se mantiene igual. |
| **540x304**      | âŒ No         | La imagen es pequeÃ±a, mantenerla evita pÃ©rdida de calidad. |

### ğŸ‘‰ Â¿Por quÃ© no redimensionamos si el lado menor es menor a 400px?
Si una imagen es **demasiado pequeÃ±a** (por ejemplo, `800x300`), es mejor **no cambiar su tamaÃ±o**, porque:
âœ… **Evita pixelaciÃ³n** â†’ Si ampliamos una imagen con `300px` de altura, perderÃ¡ calidad.
âœ… **Preserva detalles del rostro** â†’ Si la imagen es pequeÃ±a, el detector MTCNN ya trabaja con resoluciÃ³n baja, y al modificarla podemos afectar la precisiÃ³n.

### ğŸ”§ Â¿Quieres cambiar esta condiciÃ³n?
Si deseas **siempre** redimensionar si el ancho o el alto supera `800px`, sin importar el tamaÃ±o mÃ­nimo, puedes modificar la condiciÃ³n en el cÃ³digo asÃ­:
```python
if max(orig_width, orig_height) > max_dim:
```
Esto harÃ¡ que **cualquier imagen con un lado mayor a `800px` se reduzca proporcionalmente**, sin importar el otro lado.

ğŸš€ **Decide segÃºn tu caso de uso!**

## ğŸ–¼ï¸ ConfiguraciÃ³n de MTCNN en `facenet-pytorch`

Para optimizar y mejorar la precisiÃ³n de tu cÃ³digo al utilizar la clase `MTCNN` del paquete `facenet-pytorch`, es importante comprender las configuraciones disponibles y cÃ³mo ajustarlas segÃºn tus necesidades. A continuaciÃ³n, se detallan los parÃ¡metros clave que puedes considerar:

### ğŸ”§ **ParÃ¡metros principales**

ğŸ“ **`image_size`**: Define el tamaÃ±o de las imÃ¡genes de salida en pÃ­xeles. Por defecto, es `160`. Si las imÃ¡genes de entrada son de alta resoluciÃ³n, ajustar este parÃ¡metro puede ayudar a mantener la calidad y detalle necesarios para una detecciÃ³n precisa.

ğŸ–¼ï¸ **`margin`**: AÃ±ade un margen al cuadro delimitador en tÃ©rminos de pÃ­xeles en la imagen final. Esto es Ãºtil para asegurarse de que se capturen Ã¡reas adicionales alrededor del rostro, lo que puede ser beneficioso en procesos posteriores como el reconocimiento facial.

ğŸ“ **`min_face_size`**: Establece el tamaÃ±o mÃ­nimo de rostro que el detector buscarÃ¡. El valor predeterminado es `20`. Si los rostros en las imÃ¡genes son mÃ¡s grandes, aumentar este valor puede reducir falsos positivos y mejorar la eficiencia.

ğŸšï¸ **`thresholds`**: Son los umbrales de detecciÃ³n para las tres etapas de la red `MTCNN`. Los valores predeterminados son `[0.6, 0.7, 0.7]`. Ajustar estos umbrales puede influir en la sensibilidad y precisiÃ³n de la detecciÃ³n. Por ejemplo, aumentar los valores puede reducir falsos positivos, pero tambiÃ©n podrÃ­a omitir rostros menos evidentes.

ğŸ” **`factor`**: Es el factor utilizado para crear una pirÃ¡mide de escalado de tamaÃ±os de rostro. El valor predeterminado es `0.709`. Este parÃ¡metro afecta la escala en la que se analizan las imÃ¡genes para detectar rostros de diferentes tamaÃ±os.

ğŸ› ï¸ **`post_process`**: Indica si se debe postprocesar los tensores de imÃ¡genes antes de devolverlos. Por defecto, es `True`. Si estÃ¡s realizando un procesamiento personalizado despuÃ©s de la detecciÃ³n, es posible que desees desactivar esta opciÃ³n.

```text
En nuestro caso no necesitamos normalizaciÃ³n porque la detecciÃ³n de rostros se usa en un flujo de OpenCV + face_recognition. Si estuviÃ©ramos pasando los rostros a un modelo preentrenado en PyTorch, podrÃ­amos considerar dpost_process=True
```

ğŸ” **`select_largest`**: Si es `True`, en caso de que se detecten mÃºltiples rostros, se devolverÃ¡ el mÃ¡s grande. Si es `False`, se devolverÃ¡ el rostro con la mayor probabilidad de detecciÃ³n. Esto es Ãºtil si esperas que haya mÃºltiples rostros en la imagen y deseas centrarte en uno especÃ­fico.

ğŸ¯ **`selection_method`**: Especifica el mÃ©todo de selecciÃ³n cuando se detectan mÃºltiples rostros. Las opciones incluyen:
  - **`"probability"`**: selecciona el rostro con la mayor probabilidad de detecciÃ³n.
  - **`"largest"`**: selecciona el rostro mÃ¡s grande.
  - **`"largest_over_threshold"`**: selecciona el rostro mÃ¡s grande que supera un cierto umbral de probabilidad.
  - **`"center_weighted_size"`**: selecciona basado en el tamaÃ±o de la caja menos el desplazamiento ponderado al cuadrado desde el centro de la imagen.

ğŸ“‚ **`keep_all`**: Si es `True`, se devolverÃ¡n todos los rostros detectados en el orden dictado por el parÃ¡metro `select_largest`. Si se especifica una ruta de guardado (`save_path`), el primer rostro se guardarÃ¡ en esa ruta y los rostros restantes se guardarÃ¡n con sufijos numÃ©ricos.

ğŸ’» **`device`**: Especifica el dispositivo en el que se ejecutarÃ¡n las pasadas de la red neuronal. Los tensores de imÃ¡genes y los modelos se copian a este dispositivo antes de ejecutar las pasadas hacia adelante. Por defecto, es `None`, lo que significa que se utilizarÃ¡ la `CPU`, pero si tienes una `GPU` disponible, puedes especificarla para mejorar el rendimiento.

Para una comprensiÃ³n mÃ¡s profunda y ejemplos prÃ¡cticos, puedes consultar la guÃ­a de `MTCNN` en `facenet-pytorch` y la documentaciÃ³n del [repositorio oficial](https://github.com/timesler/facenet-pytorch).


